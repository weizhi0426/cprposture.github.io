<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>歷史紀錄</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        select, input, button {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #e03737;
            color: #fff;
            cursor: pointer;
        }
        button:hover {
            background-color: #b63131;
        }
        .content-box {
            margin-bottom: 20px;
            margin-left: 20px;
        }
        #upload-container {
            display: flex;
            flex-direction: column;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            gap: 20px;
        }
        #description-container, #history-content {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 0 auto;
            position: relative;
            text-align: center;
        }
        #description-container::after {
            content: "";
            display: block;
            position: absolute;
            bottom: 50%;
            left: 0;
            width: 100%;
            background-color: #706f6f;
        }
        @media (min-width: 600px) {
            #upload-container {
                flex-direction: row;
            }
            #description-container, #history-content {
                margin-left: 20px;
                width: 400px;
            }
        }
    </style>
</head>
<body>
    <div>
        <button type="button" onclick="backToMain()">繼續辨識</button>
        <button type="button" onclick="logout()">登出</button>
    </div>
    <div id="upload-container">
        <div id="lefttop">
            <div id="usernameDisplay"></div>
        </div>
        <div id="description-container">
            <h2>選擇紀錄</h2>
            <form id="history-form">
                <label for="upload-time">選擇過往檔案:</label>
                <select id="upload-time"></select>
                <button type="button" onclick="viewHistory()">查看紀錄</button>
            </form>
        </div>
        <div id="history-content"></div>
        
    </div>

    <script>
        const BASE_URL = 'https://8991-106-107-172-1.ngrok-free.app';

        function logout() {
            sessionStorage.clear();
            location.assign('index.html');
        }

        function backToMain() {
            location.assign("main.html?username=" + encodeURIComponent(username));
        }

        const urlParams = new URLSearchParams(window.location.search);
        const username = sessionStorage.getItem('username');

        const usernameDisplayElement = document.getElementById('usernameDisplay');
        if (!username) {
            location.assign('index.html');
        } else {
            usernameDisplayElement.textContent = '使用者: ' + username;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const url = `${BASE_URL}/get_recent_upload_times/`;
            const formData = new FormData();
            formData.append('username', username);

            axios.post(url, formData)
                .then(function(response) {
                    const uploadTimes = response.data;
                    const selectElement = document.getElementById('upload-time');
                    selectElement.innerHTML = '';
                    uploadTimes.forEach(function(time) {
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        selectElement.appendChild(option);
                    });
                })
                .catch(function(error) {
                    console.error('Error fetching upload times:', error);
                });
        });

        function viewHistory() {
        const selectedTime = document.getElementById('upload-time').value;
        axios.post(`${BASE_URL}/get_history/`, { username, selectedTime })
            .then(response => {
                if (response.data.error) {
                    document.getElementById('history-content').innerHTML = `<p>${response.data.error}</p>`;
                    return;
                }

                // 取得原始影片路徑
                const originalVideoUrl = response.data.uploadedFileUrl;

                // 把 URL 的 /media/ 改成 /stream/
                // 例如：https://domain/media/username/filename.mp4 → https://domain/stream/username/filename.mp4
                const videoUrl = originalVideoUrl.replace('/media/', '/stream/');

                const suggestionContent = response.data.suggestionContent;
                const historyContent = document.getElementById('history-content');

                historyContent.innerHTML = `
                    <div class="content-box">
                        <h2>影片檔:</h2>
                        <video width="320" height="240" controls preload="metadata" crossorigin="anonymous">
                            <source src="${videoUrl}" type="video/mp4" />
                            您的瀏覽器不支援影片播放。
                        </video>
                    </div>
                    <div class="content-box">
                        <h2>建議:</h2>
                        <pre>${suggestionContent}</pre>
                    </div>
                `;

                const video = historyContent.querySelector('video');
                if (video) {
                    video.load();
                    video.addEventListener('error', e => {
                        console.error('影片載入錯誤:', e);
                        alert('無法載入影片，請確認伺服器是否正常或影片連結是否正確。');
                    });
                }
            })
            .catch(error => {
                if (error.response?.status === 503) {
                    console.log('影片正在寫入，1秒後重試...');
                    setTimeout(viewHistory, 1000);
                } else {
                    alert("查無資料");
                    console.error('Error fetching history:', error);
                }
            });
    }
    </script>
</body>
</html>
